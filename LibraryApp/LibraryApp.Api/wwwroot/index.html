<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Caminho do Saber - Sua Biblioteca Digital</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo">üìö</div>
                    <div class="logo-text">O Caminho do Saber</div>
                </div>

                <div class="user-section" id="userSection">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>

            <h1>Biblioteca Digital</h1>
            <p>Explore, leia e compartilhe conhecimento gratuitamente</p>

            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="Buscar livros por t√≠tulo...">
                <button class="search-btn" onclick="searchBooks()">üîç</button>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalBooks">0</div>
                <div class="stat-label">Livros Dispon√≠veis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentPageStat">1</div>
                <div class="stat-label">P√°gina Atual</div>
            </div>
        </div>

        <!-- BOOKS GRID -->
        <div class="content-section">
            <h2 style="margin-bottom: 20px; color: #4a54e1;">üìñ Cat√°logo de Livros</h2>
            <div id="booksGrid" class="books-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Carregando livros...</p>
                </div>
            </div>

            <!-- PAGINA√á√ÉO -->
            <div id="paginationContainer" class="pagination-container" style="display: none;">
                <button id="btnFirstPage" onclick="goToPage(1)">¬´ Primeira</button>
                <button id="btnPrevPage" onclick="goToPreviousPage()">‚Äπ Anterior</button>
                <span class="pagination-info" id="paginationInfo">P√°gina 1 de 1</span>
                <button id="btnNextPage" onclick="goToNextPage()">Pr√≥xima ‚Ä∫</button>
                <button id="btnLastPage" onclick="goToLastPage()">√öltima ¬ª</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeLoginModal()">‚úï</button>
            <h2>üîë Entrar na Conta</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>E-mail ou Username</label>
                    <input type="text" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">Entrar</button>
            </form>
            <div class="modal-link">
                N√£o tem conta? <a href="#" onclick="showRegisterModal()">Cadastre-se</a>
            </div>
            <button onclick="loginWithGoogle()" class="social-btn">
                üî¥ Continuar com Google
            </button>
        </div>
    </div>

    <!-- MODAL DE REGISTRO -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeRegisterModal()">‚úï</button>
            <h2>‚ú® Criar Conta</h2>
            <form onsubmit="register(event)">
                <div class="form-group">
                    <label>Username/Nick</label>
                    <input type="text" id="registerUsername" required minlength="3">
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>
                <button type="submit" class="btn-primary" id="registerBtn">Criar Conta</button>
            </form>
            <div class="modal-link">
                J√° tem conta? <a href="#" onclick="showLoginModal()">Entrar</a>
            </div>
        </div>
    </div>

    <!-- MODAL DE UPLOAD -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUploadModal()">‚úï</button>
            <h2>üì§ Enviar Novo Livro</h2>
            <form onsubmit="uploadBook(event)">
                <div class="form-group">
                    <label>T√≠tulo do Livro *</label>
                    <input type="text" id="bookTitle" required maxlength="100">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o *</label>
                    <textarea id="bookDescription" rows="4" required maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label>Arquivo do Livro (PDF, EPUB) *</label>
                    <input type="file" id="bookFile" accept=".pdf,.epub" required>
                </div>
                <div class="form-group">
                    <label>Capa (opcional)</label>
                    <input type="file" id="bookCover" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Categorias *</label>
                    <input type="text" class="categories-search" id="categoriesSearch" placeholder="Buscar categorias...">
                    <div class="categories-container">
                        <div class="categories-grid" id="categoriesGrid">
                            <!-- Categorias ser√£o carregadas dinamicamente aqui -->
                        </div>
                    </div>
                    <div class="selected-categories" id="selectedCategories">
                        <!-- Categorias selecionadas aparecer√£o aqui -->
                    </div>
                </div>
                <button type="submit" class="btn-primary" id="uploadBtn">Enviar Livro</button>
            </form>
        </div>
    </div>

    <!-- NOTIFICA√á√ÉO -->
    <div id="notification" class="notification"></div>

    <!-- INCLUIR SCRIPTS EXTERNOS -->
    <script src="data.js"></script>
    <script src="api-integration.js"></script>

    <script>
        // ========== ESTADO DA APLICA√á√ÉO ==========
        let currentBooks = [];
        let currentPage = 1;
        let totalPages = 1;
        let totalItems = 0;
        const booksPerPage = 12;

        // ========== CATEGORIAS ==========
        let categories = {};
        let selectedCategories = [];

        // ========== AUTENTICA√á√ÉO ==========

        function updateAuthUI() {
            const userSection = document.getElementById('userSection');
            const user = AuthService.getCurrentUser();

            if (user) {
                userSection.innerHTML = `
                        <div class="user-info">
                            <span>üë§</span>
                            <span>${escapeHtml(user.userName || user.email)}</span>
                        </div>
                        <button class="btn-upload" onclick="showUploadModal()">üì§ Enviar</button>
                        <button class="btn-logout" onclick="logout()">Sair</button>
                    `;
            } else {
                userSection.innerHTML = `
                        <button class="btn-login" onclick="showLoginModal()">üîë Entrar</button>
                        <button class="btn-login" onclick="showRegisterModal()">‚ú® Cadastrar</button>
                    `;
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            closeRegisterModal();
            closeUploadModal();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            closeLoginModal();
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
        }

        async function login(event) {
            event.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Entrando...';

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const result = await AuthService.login(email, password);

            if (result.success) {
                showNotification('Login realizado com sucesso!', 'success');
                closeLoginModal();
                updateAuthUI();
                loadBooks(currentPage);
            } else {
                showNotification(result.error || 'Erro ao fazer login', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Entrar';
        }

        async function register(event) {
            event.preventDefault();
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'Criando...';

            const userName = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const result = await AuthService.register(userName, email, password);

            if (result.success) {
                showNotification(result.message || 'Conta criada! Verifique seu e-mail.', 'success');
                closeRegisterModal();
                setTimeout(() => showLoginModal(), 2000);
            } else {
                showNotification(result.error || 'Erro ao criar conta', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Criar Conta';
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                AuthService.logout();
                updateAuthUI();
                showNotification('Logout realizado com sucesso!', 'info');
                loadBooks(1);
            }
        }

        function loginWithGoogle() {
            AuthService.loginWithGoogle();
        }

        // ========== LIVROS COM PAGINA√á√ÉO ==========

        async function loadBooks(page = 1) {
            try {
                showLoading(true);

                const response = await BookService.getBooksPaginated(page, booksPerPage);

                if (response.success && response.data) {
                    const paginatedData = response.data;

                    currentBooks = paginatedData.books || [];
                    currentPage = paginatedData.currentPage || 1;
                    totalPages = paginatedData.totalPages || 1;
                    totalItems = paginatedData.totalItems || 0;

                    await renderBooks(currentBooks);
                    updatePagination(paginatedData);
                    updateStats();
                } else {
                    throw new Error(response.error || 'Erro ao carregar livros');
                }
            } catch (error) {
                console.error('Erro ao carregar livros:', error);
                showNotification('Erro ao carregar livros', 'error');
                document.getElementById('booksGrid').innerHTML =
                    '<p style="text-align: center; color: #666;">Erro ao carregar livros. Tente novamente.</p>';
            } finally {
                showLoading(false);
            }
        }

        async function renderBooks(books) {
            const grid = document.getElementById('booksGrid');

            if (!books || books.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Nenhum livro encontrado.</p>';
                return;
            }

            // Buscar detalhes completos de cada livro para obter coverUrl
            const booksWithDetails = await Promise.all(
                books.map(async (book) => {
                    try {
                        const detailResponse = await BookService.getBookById(book.id);
                        if (detailResponse.success && detailResponse.book) {
                            return detailResponse.book;
                        }
                        return book;
                    } catch (error) {
                        console.error(`Erro ao buscar detalhes do livro ${book.id}:`, error);
                        return book;
                    }
                })
            );

            grid.innerHTML = booksWithDetails.map(book => {
                // Construir URL da capa corretamente
                let coverImageHtml;
                if (book.coverUrl) {
                    const imageUrl = book.coverUrl;
                    coverImageHtml = `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(book.title)}">`;
                } else {
                    coverImageHtml = 'üìñ';
                }

                return `
                        <div class="book-card">
                            <div class="book-cover">
                                ${coverImageHtml}
                            </div>
                            <div class="book-title">${escapeHtml(book.title)}</div>
                            <div class="book-author">por: ${escapeHtml(book.authorName || 'Desconhecido')}</div>
                            <div class="book-stats">
                                üëÅÔ∏è ${book.viewsCount || 0} visualiza√ß√µes
                            </div>
                            <div class="book-actions">
                                <button class="btn btn-read" onclick="readBook(${book.id})" title="Ler livro">
                                    üìñ Ler Livro
                                </button>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function updatePagination(paginatedData) {
            const container = document.getElementById('paginationContainer');
            const info = document.getElementById('paginationInfo');
            const btnFirst = document.getElementById('btnFirstPage');
            const btnPrev = document.getElementById('btnPrevPage');
            const btnNext = document.getElementById('btnNextPage');
            const btnLast = document.getElementById('btnLastPage');

            if (totalPages > 1) {
                container.style.display = 'flex';
                info.textContent = `P√°gina ${currentPage} de ${totalPages} (${totalItems} livros)`;
                btnFirst.disabled = !paginatedData.hasPreviousPage;
                btnPrev.disabled = !paginatedData.hasPreviousPage;
                btnNext.disabled = !paginatedData.hasNextPage;
                btnLast.disabled = !paginatedData.hasNextPage;
            } else {
                container.style.display = 'none';
            }
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                loadBooks(page);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function goToPreviousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        function showLoading(show) {
            const grid = document.getElementById('booksGrid');
            if (show) {
                grid.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">Carregando livros...</p>
                        </div>
                    `;
            }
        }

        function searchBooks() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            if (!query) {
                loadBooks(1);
                return;
            }

            const filtered = currentBooks.filter(book =>
                book.title.toLowerCase().includes(query)
            );

            renderBooks(filtered);
            document.getElementById('paginationContainer').style.display = 'none';
            showNotification(`${filtered.length} livro(s) encontrado(s)`, 'info');
        }

        function readBook(bookId) {
            window.location.href = `full-book.html?id=${bookId}`;
        }

        // ========== CATEGORIAS ==========

        async function loadCategories() {
            try {
                if (typeof CategoryService !== 'undefined' && CategoryService.getCategories) {
                    const response = await CategoryService.getCategories();
                    if (response.success && response.data) {
                        categories = response.data.categories || response.data.Categories || [];
                        console.log('Categorias carregadas:', categories);
                        return;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                showNotification('Erro ao carregar categorias', 'error');
            }
        }

        function renderCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            const searchTerm = document.getElementById('categoriesSearch').value.toLowerCase();

            const filteredCategories = categories.filter(category =>
                category.name.toLowerCase().includes(searchTerm)
            );

            categoriesGrid.innerHTML = filteredCategories.map(category => {
                const isSelected = selectedCategories.some(c => c.id === category.id);

                return `
                        <div class="category-item ${isSelected ? 'selected' : ''}"
                             onclick="toggleCategory(${category.id}, '${escapeHtml(category.name)}')">
                            <input type="checkbox" class="category-checkbox"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleCategory(${category.id}, '${escapeHtml(category.name)}')">
                            <span class="category-label">${escapeHtml(category.name)}</span>
                        </div>
                    `;
            }).join('');

            updateSelectedCategoriesDisplay();
        }

        function toggleCategory(id, name) {
            const existingIndex = selectedCategories.findIndex(c => c.id === id);

            if (existingIndex >= 0) {
                selectedCategories.splice(existingIndex, 1);
            } else {
                selectedCategories.push({ id, name });
            }

            renderCategories();
        }

        function removeCategory(id) {
            selectedCategories = selectedCategories.filter(c => c.id !== id);
            renderCategories();
        }

        function updateSelectedCategoriesDisplay() {
            const container = document.getElementById('selectedCategories');

            if (selectedCategories.length === 0) {
                container.innerHTML = '<small style="color: #666;">Nenhuma categoria selecionada</small>';
                return;
            }

            container.innerHTML = selectedCategories.map(category => `
                    <div class="selected-category-tag">
                        ${escapeHtml(category.name)}
                        <button class="remove-category" onclick="removeCategory(${category.id})">‚úï</button>
                    </div>
                `).join('');
        }

        function filterCategories() {
            renderCategories();
        }

        // ========== UPLOAD ==========

        function showUploadModal() {
            if (!AuthService.isAuthenticated()) {
                showNotification('Fa√ßa login para enviar livros', 'info');
                showLoginModal();
                return;
            }

            selectedCategories = [];
            document.getElementById('categoriesSearch').value = '';

            loadCategories().then(() => {
                renderCategories();
            });

            document.getElementById('uploadModal').classList.add('show');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
        }

        async function uploadBook(event) {
            event.preventDefault();
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            const title = document.getElementById('bookTitle').value;
            const description = document.getElementById('bookDescription').value;
            const file = document.getElementById('bookFile').files[0];
            const cover = document.getElementById('bookCover').files[0];

            const categoriesIds = selectedCategories.map(c => c.id);

            if (categoriesIds.length === 0) {
                showNotification('Por favor, selecione pelo menos uma categoria', 'error');
                btn.disabled = false;
                btn.textContent = 'Enviar Livro';
                return;
            }

            const result = await BookService.createBook(title, description, file, cover, categoriesIds);

            if (result.success) {
                showNotification('Livro enviado com sucesso!', 'success');
                closeUploadModal();
                event.target.reset();
                selectedCategories = [];
                loadBooks(1);
            } else {
                showNotification(result.error || 'Erro ao enviar livro', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Enviar Livro';
        }

        // ========== UTILS ==========

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateStats() {
            document.getElementById('totalBooks').textContent = totalItems;
            document.getElementById('currentPageStat').textContent = currentPage;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== INICIALIZA√á√ÉO ==========

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìö O Caminho do Saber iniciando com pagina√ß√£o...');

            const initApp = () => {
                if (typeof AuthService === 'undefined') {
                    setTimeout(initApp, 100);
                    return;
                }

                updateAuthUI();
                loadBooks(1);

                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchBooks();
                });

                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (e.target.value.length >= 2) {
                            searchBooks();
                        } else if (e.target.value.length === 0) {
                            loadBooks(currentPage);
                        }
                    }, 500);
                });

                document.getElementById('categoriesSearch').addEventListener('input', filterCategories);

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('show');
                        }
                    });
                });

                console.log('‚úÖ O Caminho do Saber inicializado com sistema de pagina√ß√£o e categorias!');
            };

            initApp();
        });
    </script>
</body>
</html>