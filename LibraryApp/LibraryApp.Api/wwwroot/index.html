<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioLivre - Sua Biblioteca Digital</title>
    <style>
        /* Estilos anteriores permanecem os mesmos */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            font-size: 2rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a54e1;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(74, 84, 225, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            color: #4a54e1;
            font-weight: 600;
        }

        .btn-login, .btn-logout, .btn-upload {
            background: linear-gradient(135deg, #4a54e1, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(74, 84, 225, 0.3);
        }

            .btn-login:hover, .btn-logout:hover, .btn-upload:hover {
                background: linear-gradient(135deg, #3742c7, #5a3d7a);
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(74, 84, 225, 0.4);
            }

        .btn-logout {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 0.9rem;
        }

            .btn-logout:hover {
                background: #c82333;
            }

        .header h1 {
            color: #4a54e1;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
        }

        /* SEARCH */
        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-box {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 50px;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s ease;
        }

            .search-box:focus {
                border-color: #4a54e1;
                box-shadow: 0 0 15px rgba(74, 84, 225, 0.2);
            }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #4a54e1;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

            .search-btn:hover {
                background: #3742c7;
            }

        /* STATS */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a54e1;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
        }

        /* BOOKS GRID */
        .content-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .book-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

            .book-card:hover {
                transform: translateY(-10px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            }

        .book-cover {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
        }

            .book-cover img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 10px;
                display: block;
            }

                .book-cover img[src=""],
                .book-cover img:not([src]) {
                    display: none;
            }

        .book-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            min-height: 48px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .book-author {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .book-stats {
            margin: 10px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .book-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-read {
            background: #28a745;
            color: white;
            flex: 1;
        }

            .btn-read:hover {
                background: #218838;
                transform: translateY(-2px);
            }

        .btn-like {
            background: #6c757d;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

            .btn-like:hover {
                transform: scale(1.1);
            }

            .btn-like.liked {
                background: #dc3545;
            }

        /* PAGINA√á√ÉO */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

            .pagination-container button {
                padding: 10px 16px;
                border: 2px solid #4a54e1;
                background: white;
                color: #4a54e1;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                font-size: 0.9rem;
            }

                .pagination-container button:hover:not(:disabled) {
                    background: #4a54e1;
                    color: white;
                    transform: translateY(-2px);
                }

                .pagination-container button:disabled {
                    opacity: 0.3;
                    cursor: not-allowed;
                }

        .pagination-info {
            color: #666;
            font-size: 0.9rem;
            padding: 0 10px;
            font-weight: 500;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a54e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
            display: none;
        }

            .notification.show {
                display: block;
            }

            .notification.success {
                background: #28a745;
            }

            .notification.error {
                background: #dc3545;
            }

            .notification.info {
                background: #17a2b8;
            }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .modal.show {
                display: flex;
            }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

            .modal-close:hover {
                color: #333;
            }

        .modal h2 {
            color: #4a54e1;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #333;
            }

            .form-group input, .form-group textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 1rem;
            }

                .form-group input:focus, .form-group textarea:focus {
                    outline: none;
                    border-color: #4a54e1;
                }

        .btn-primary {
            background: linear-gradient(135deg, #4a54e1, #764ba2);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(74, 84, 225, 0.3);
            }

            .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

        .modal-link {
            text-align: center;
            margin-top: 15px;
            color: #666;
        }

            .modal-link a {
                color: #4a54e1;
                font-weight: bold;
                text-decoration: none;
            }

                .modal-link a:hover {
                    text-decoration: underline;
                }

        .social-btn {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

            .social-btn:hover {
                background: #f8f9fa;
                transform: translateY(-2px);
            }

        /* NOVOS ESTILOS PARA CATEGORIAS COM ROLAGEM */
        .categories-container {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-top: 5px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
            background: white;
        }

            .category-item:hover {
                background: #f8f9fa;
            }

            .category-item.selected {
                background: rgba(74, 84, 225, 0.1);
                border-color: #4a54e1;
                color: #4a54e1;
            }

        .category-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #4a54e1;
        }

        .category-label {
            font-size: 0.9rem;
            cursor: pointer;
        }

        .selected-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .selected-category-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(74, 84, 225, 0.1);
            color: #4a54e1;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .remove-category {
            background: none;
            border: none;
            color: #4a54e1;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .categories-search {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

            .categories-search:focus {
                outline: none;
                border-color: #4a54e1;
            }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .user-section {
                width: 100%;
                justify-content: center;
            }

            .btn-login, .btn-logout, .btn-upload {
                width: 100%;
            }

            .pagination-container {
                gap: 5px;
            }

                .pagination-container button {
                    padding: 8px 12px;
                    font-size: 0.85rem;
                }

            .categories-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo">üìö</div>
                    <div class="logo-text">BiblioLivre</div>
                </div>

                <div class="user-section" id="userSection">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>

            <h1>Biblioteca Digital</h1>
            <p>Explore, leia e compartilhe conhecimento gratuitamente</p>

            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="Buscar livros por t√≠tulo...">
                <button class="search-btn" onclick="searchBooks()">üîç</button>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalBooks">0</div>
                <div class="stat-label">Livros Dispon√≠veis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentPageStat">1</div>
                <div class="stat-label">P√°gina Atual</div>
            </div>
        </div>

        <!-- BOOKS GRID -->
        <div class="content-section">
            <h2 style="margin-bottom: 20px; color: #4a54e1;">üìñ Cat√°logo de Livros</h2>
            <div id="booksGrid" class="books-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Carregando livros...</p>
                </div>
            </div>

            <!-- PAGINA√á√ÉO -->
            <div id="paginationContainer" class="pagination-container" style="display: none;">
                <button id="btnFirstPage" onclick="goToPage(1)">¬´ Primeira</button>
                <button id="btnPrevPage" onclick="goToPreviousPage()">‚Äπ Anterior</button>
                <span class="pagination-info" id="paginationInfo">P√°gina 1 de 1</span>
                <button id="btnNextPage" onclick="goToNextPage()">Pr√≥xima ‚Ä∫</button>
                <button id="btnLastPage" onclick="goToLastPage()">√öltima ¬ª</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeLoginModal()">‚úï</button>
            <h2>üîë Entrar na Conta</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>E-mail ou Username</label>
                    <input type="text" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">Entrar</button>
            </form>
            <div class="modal-link">
                N√£o tem conta? <a href="#" onclick="showRegisterModal()">Cadastre-se</a>
            </div>
            <button onclick="loginWithGoogle()" class="social-btn">
                üî¥ Continuar com Google
            </button>
        </div>
    </div>

    <!-- MODAL DE REGISTRO -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeRegisterModal()">‚úï</button>
            <h2>‚ú® Criar Conta</h2>
            <form onsubmit="register(event)">
                <div class="form-group">
                    <label>Username/Nick</label>
                    <input type="text" id="registerUsername" required minlength="3">
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>
                <button type="submit" class="btn-primary" id="registerBtn">Criar Conta</button>
            </form>
            <div class="modal-link">
                J√° tem conta? <a href="#" onclick="showLoginModal()">Entrar</a>
            </div>
        </div>
    </div>

    <!-- MODAL DE UPLOAD -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUploadModal()">‚úï</button>
            <h2>üì§ Enviar Novo Livro</h2>
            <form onsubmit="uploadBook(event)">
                <div class="form-group">
                    <label>T√≠tulo do Livro *</label>
                    <input type="text" id="bookTitle" required maxlength="100">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o *</label>
                    <textarea id="bookDescription" rows="4" required maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label>Arquivo do Livro (PDF, EPUB) *</label>
                    <input type="file" id="bookFile" accept=".pdf,.epub" required>
                </div>
                <div class="form-group">
                    <label>Capa (opcional)</label>
                    <input type="file" id="bookCover" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Categorias *</label>
                    <input type="text" class="categories-search" id="categoriesSearch" placeholder="Buscar categorias...">
                    <div class="categories-container">
                        <div class="categories-grid" id="categoriesGrid">
                            <!-- Categorias ser√£o carregadas dinamicamente aqui -->
                        </div>
                    </div>
                    <div class="selected-categories" id="selectedCategories">
                        <!-- Categorias selecionadas aparecer√£o aqui -->
                    </div>
                </div>
                <button type="submit" class="btn-primary" id="uploadBtn">Enviar Livro</button>
            </form>
        </div>
    </div>

    <!-- NOTIFICA√á√ÉO -->
    <div id="notification" class="notification"></div>

    <!-- INCLUIR SCRIPTS EXTERNOS -->
    <script src="data.js"></script>
    <script src="api-integration.js"></script>

    <script>
        // ========== ESTADO DA APLICA√á√ÉO ==========
        let currentBooks = [];
        let likedBooks = new Set();
        let currentPage = 1;
        let totalPages = 1;
        let totalItems = 0;
        const booksPerPage = 12;
        
        // ========== CATEGORIAS ==========
        let categories = {};
        let selectedCategories = [];

        // ========== AUTENTICA√á√ÉO ==========

        function updateAuthUI() {
            const userSection = document.getElementById('userSection');
            const user = AuthService.getCurrentUser();

            if (user) {
                userSection.innerHTML = `
                        <div class="user-info">
                            <span>üë§</span>
                            <span>${escapeHtml(user.userName || user.email)}</span>
                        </div>
                        <button class="btn-upload" onclick="showUploadModal()">üì§ Enviar</button>
                        <button class="btn-logout" onclick="logout()">Sair</button>
                    `;
            } else {
                userSection.innerHTML = `
                        <button class="btn-login" onclick="showLoginModal()">üîë Entrar</button>
                        <button class="btn-login" onclick="showRegisterModal()">‚ú® Cadastrar</button>
                    `;
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            closeRegisterModal();
            closeUploadModal();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            closeLoginModal();
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
        }

        async function login(event) {
            event.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Entrando...';

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const result = await AuthService.login(email, password);

            if (result.success) {
                showNotification('Login realizado com sucesso!', 'success');
                closeLoginModal();
                updateAuthUI();
                loadBooks(currentPage);
            } else {
                showNotification(result.error || 'Erro ao fazer login', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Entrar';
        }

        async function register(event) {
            event.preventDefault();
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'Criando...';

            const userName = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const result = await AuthService.register(userName, email, password);

            if (result.success) {
                showNotification(result.message || 'Conta criada! Verifique seu e-mail.', 'success');
                closeRegisterModal();
                setTimeout(() => showLoginModal(), 2000);
            } else {
                showNotification(result.error || 'Erro ao criar conta', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Criar Conta';
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                AuthService.logout();
                likedBooks.clear();
                updateAuthUI();
                showNotification('Logout realizado com sucesso!', 'info');
                loadBooks(1);
            }
        }

        function loginWithGoogle() {
            AuthService.loginWithGoogle();
        }

        // ========== LIVROS COM PAGINA√á√ÉO ==========

        async function loadBooks(page = 1) {
            try {
                showLoading(true);

                const response = await BookService.getBooksPaginated(page, booksPerPage);

                if (response.success && response.data) {
                    const paginatedData = response.data;

                    currentBooks = paginatedData.books || [];
                    currentPage = paginatedData.currentPage || 1;
                    totalPages = paginatedData.totalPages || 1;
                    totalItems = paginatedData.totalItems || 0;

                    await renderBooks(currentBooks);
                    updatePagination(paginatedData);
                    updateStats();
                } else {
                    throw new Error(response.error || 'Erro ao carregar livros');
                }
            } catch (error) {
                console.error('Erro ao carregar livros:', error);
                showNotification('Erro ao carregar livros', 'error');
                document.getElementById('booksGrid').innerHTML =
                    '<p style="text-align: center; color: #666;">Erro ao carregar livros. Tente novamente.</p>';
            } finally {
                showLoading(false);
            }
        }

        async function renderBooks(books) {
            const grid = document.getElementById('booksGrid');

            if (!books || books.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Nenhum livro encontrado.</p>';
                return;
            }

            // Buscar detalhes completos de cada livro para obter coverUrl
            const booksWithDetails = await Promise.all(
                books.map(async (book) => {
                    try {
                        const detailResponse = await BookService.getBookById(book.id);
                        if (detailResponse.success && detailResponse.book) {
                            return detailResponse.book;
                        }
                        return book;
                    } catch (error) {
                        console.error(`Erro ao buscar detalhes do livro ${book.id}:`, error);
                        return book;
                    }
                })
            );

            grid.innerHTML = booksWithDetails.map(book => {
                const isLiked = likedBooks.has(book.id);

                // Construir URL da capa corretamente
                let coverImageHtml;
                if (book.coverUrl) {
                    // Se a URL j√° est√° completa (come√ßa com http/https)
                    const imageUrl = book.coverUrl;

                    coverImageHtml = `<img src="${escapeHtml(imageUrl)}"
                                               alt="${escapeHtml(book.title)}"
                                               onerror="this.parentElement.innerHTML='üìñ'">`;
                } else {
                    coverImageHtml = 'üìñ';
                }

                return `
                        <div class="book-card">
                            <div class="book-cover">
                                ${coverImageHtml}
                            </div>
                            <div class="book-title">${escapeHtml(book.title)}</div>
                            <div class="book-author">por: ${escapeHtml(book.user?.userName || 'Desconhecido')}</div>
                            <div class="book-stats">
                                ‚ù§Ô∏è ${book.likesCount || 0} curtidas
                            </div>
                            <div class="book-actions">
                                <button class="btn btn-read" onclick="readBook(${book.id})" title="Ler livro">
                                    üìñ Ler
                                </button>
                                <button class="btn btn-like ${isLiked ? 'liked' : ''}"
                                        onclick="toggleLike(${book.id})"
                                        title="${isLiked ? 'Descurtir' : 'Curtir'}">
                                    ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
                                </button>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function updatePagination(paginatedData) {
            const container = document.getElementById('paginationContainer');
            const info = document.getElementById('paginationInfo');
            const btnFirst = document.getElementById('btnFirstPage');
            const btnPrev = document.getElementById('btnPrevPage');
            const btnNext = document.getElementById('btnNextPage');
            const btnLast = document.getElementById('btnLastPage');

            if (totalPages > 1) {
                container.style.display = 'flex';

                info.textContent = `P√°gina ${currentPage} de ${totalPages} (${totalItems} livros)`;

                btnFirst.disabled = !paginatedData.hasPreviousPage;
                btnPrev.disabled = !paginatedData.hasPreviousPage;
                btnNext.disabled = !paginatedData.hasNextPage;
                btnLast.disabled = !paginatedData.hasNextPage;
            } else {
                container.style.display = 'none';
            }
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                loadBooks(page);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function goToPreviousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        function showLoading(show) {
            const grid = document.getElementById('booksGrid');
            if (show) {
                grid.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">Carregando livros...</p>
                        </div>
                    `;
            }
        }

        function searchBooks() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            if (!query) {
                loadBooks(1);
                return;
            }

            const filtered = currentBooks.filter(book =>
                book.title.toLowerCase().includes(query)
            );

            renderBooks(filtered);
            document.getElementById('paginationContainer').style.display = 'none';
            showNotification(`${filtered.length} livro(s) encontrado(s)`, 'info');
        }

        async function toggleLike(bookId) {
            if (!AuthService.isAuthenticated()) {
                showNotification('Fa√ßa login para curtir livros', 'info');
                showLoginModal();
                return;
            }

            try {
                if (likedBooks.has(bookId)) {
                    const result = await BookService.unlikeBook(bookId);
                    if (result.success) {
                        likedBooks.delete(bookId);
                        showNotification('Curtida removida', 'info');
                    }
                } else {
                    const result = await BookService.likeBook(bookId);
                    if (result.success) {
                        likedBooks.add(bookId);
                        showNotification('Livro curtido!', 'success');
                    }
                }
                loadBooks(currentPage);
            } catch (error) {
                showNotification('Erro ao processar curtida', 'error');
            }
        }

        function readBook(bookId) {
            const book = currentBooks.find(b => b.id === bookId);
            if (book && book.fileUrl) {
                window.open(book.fileUrl, '_blank');
                showNotification('Abrindo livro...', 'info');
            } else {
                showNotification('Arquivo do livro n√£o dispon√≠vel', 'error');
            }
        }

        // ========== CATEGORIAS ==========

        async function loadCategories() {
            try {
                // Tentar carregar categorias da API
                if (typeof CategoryService !== 'undefined' && CategoryService.getCategories) {
                    const response = await CategoryService.getCategories();
                    if (response.success && response.data) {
                        // A API retorna { Categories: [...] }
                        categories = response.data.categories || response.data.Categories || [];
                        console.log('Categorias carregadas:', categories);
                        return;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                showNotification('Erro ao carregar categorias', 'error');
            }
        }

        function renderCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            const searchTerm = document.getElementById('categoriesSearch').value.toLowerCase();
            
            // Filtrar categorias baseado na busca
            const filteredCategories = categories.filter(category => 
                category.name.toLowerCase().includes(searchTerm)
            );
            
            categoriesGrid.innerHTML = filteredCategories.map(category => {
                const isSelected = selectedCategories.some(c => c.id === category.id);
                
                return `
                    <div class="category-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleCategory(${category.id}, '${escapeHtml(category.name)}')">
                        <input type="checkbox" class="category-checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleCategory(${category.id}, '${escapeHtml(category.name)}')">
                        <span class="category-label">${escapeHtml(category.name)}</span>
                    </div>
                `;
            }).join('');
            
            updateSelectedCategoriesDisplay();
        }

        function toggleCategory(id, name) {
            const existingIndex = selectedCategories.findIndex(c => c.id === id);
            
            if (existingIndex >= 0) {
                // Remover categoria se j√° estiver selecionada
                selectedCategories.splice(existingIndex, 1);
            } else {
                // Adicionar categoria se n√£o estiver selecionada
                selectedCategories.push({ id, name });
            }
            
            renderCategories();
        }

        function removeCategory(id) {
            selectedCategories = selectedCategories.filter(c => c.id !== id);
            renderCategories();
        }

        function updateSelectedCategoriesDisplay() {
            const container = document.getElementById('selectedCategories');
            
            if (selectedCategories.length === 0) {
                container.innerHTML = '<small style="color: #666;">Nenhuma categoria selecionada</small>';
                return;
            }
            
            container.innerHTML = selectedCategories.map(category => `
                <div class="selected-category-tag">
                    ${escapeHtml(category.name)}
                    <button class="remove-category" onclick="removeCategory(${category.id})">‚úï</button>
                </div>
            `).join('');
        }

        function filterCategories() {
            renderCategories();
        }

        // ========== UPLOAD ==========

        function showUploadModal() {
            if (!AuthService.isAuthenticated()) {
                showNotification('Fa√ßa login para enviar livros', 'info');
                showLoginModal();
                return;
            }
            
            // Limpar sele√ß√µes anteriores
            selectedCategories = [];
            document.getElementById('categoriesSearch').value = '';
            
            // Carregar e renderizar categorias
            loadCategories().then(() => {
                renderCategories();
            });
            
            document.getElementById('uploadModal').classList.add('show');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
        }

        async function uploadBook(event) {
            event.preventDefault();
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            const title = document.getElementById('bookTitle').value;
            const description = document.getElementById('bookDescription').value;
            const file = document.getElementById('bookFile').files[0];
            const cover = document.getElementById('bookCover').files[0];
            
            // Obter IDs das categorias selecionadas
            const categoriesIds = selectedCategories.map(c => c.id);

            if (categoriesIds.length === 0) {
                showNotification('Por favor, selecione pelo menos uma categoria', 'error');
                btn.disabled = false;
                btn.textContent = 'Enviar Livro';
                return;
            }

            const result = await BookService.createBook(title, description, file, cover, categoriesIds);

            if (result.success) {
                showNotification('Livro enviado com sucesso!', 'success');
                closeUploadModal();
                event.target.reset();
                selectedCategories = [];
                loadBooks(1);
            } else {
                showNotification(result.error || 'Erro ao enviar livro', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Enviar Livro';
        }

        // ========== UTILS ==========

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateStats() {
            document.getElementById('totalBooks').textContent = totalItems;
            document.getElementById('currentPageStat').textContent = currentPage;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== INICIALIZA√á√ÉO ==========

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìö BiblioLivre iniciando com pagina√ß√£o...');

            const initApp = () => {
                if (typeof AuthService === 'undefined') {
                    setTimeout(initApp, 100);
                    return;
                }

                updateAuthUI();
                loadBooks(1);

                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchBooks();
                });

                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (e.target.value.length >= 2) {
                            searchBooks();
                        } else if (e.target.value.length === 0) {
                            loadBooks(currentPage);
                        }
                    }, 500);
                });

                // Event listener para busca de categorias
                document.getElementById('categoriesSearch').addEventListener('input', filterCategories);

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('show');
                        }
                    });
                });

                console.log('‚úÖ BiblioLivre inicializado com sistema de pagina√ß√£o e categorias!');
            };

            initApp();
        });
    </script>
</body>
</html>